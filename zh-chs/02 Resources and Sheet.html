<html>
<head>
    <title>资源与账</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="github-markdown.css">
    <style>
        .markdown-body {
            box-sizing: border-box;
            min-width: 200px;
            max-width: 980px;
            margin: 0 auto;
            padding: 45px;
        }
    </style>
</head>
<body>
    <article class="markdown-body">
        <h2>简介</h2>
        <p>现在我们已经知道，管理软件首要管理的是资源，那么企业通常有哪些资源呢？</p>
        <p>最常见的就是钱，比如你可以说这个企业现在有1,000,000人民币，其中200,000万的现金以及800,000万的银行存款。还有一种常见的是物料，例如A仓库里面有10,000瓶X牌可乐成品，还有20吨的X牌可乐原浆，这些资源我们可以使用数量来衡量他的量。</p>
        <p>有些种类的资源具有时间的敏感性，例如加工机床，我们在评估这个资源时，不仅关心它有几台机床，还关心这些机床在今天能够提供多少小时的加工服务。</p>
        <p>在软件设计中，我们使用账来记录这些资源的变动情况，并通过此信息查询到某个时间点这些资源的量。下面我们将逐一介绍帐处理的各个要素。</p>
        <h2>账的要素</h2>
        <h3>数量</h3>
        <p>数量是评估资源的基础，在发生变动时，我们使用数量描述变动的量，例如卖了3瓶X牌可乐，这里的3就是数量。在查询某个时间点的资源的量时，也使用数量，例如当前我的库存有100瓶X牌可乐。数量是一个数字，因此他是可以计算的，例如我可以将这个月的所有销售的X牌可乐的数量进行累加，得到这个月的销售数量。</p>
        <p>但是，不是数量之间都可以计算的，这个计算是有前提的，例如你不能将3瓶的瓶装X牌可乐与散装的1吨原料进行累加，也不能将100元人民币与200美元进行累加。</p>
        <h3>单位</h3>
        <p>数量一定与单位关联，你必须说3<em>瓶</em>可乐，或者100<em>元</em>人民币，或者3.25<em>千克</em>的猪肉。因此，变动信息除包含数量外，还应该包含单位。但在实践中，我们将单位与具体的资源主体强关联，意思是我们在X牌可乐这个物料资源中，明确指明唯一单位是<em>瓶</em>，在X牌可乐原浆中明确指明单位是<em>吨</em>，人民币这个资源的唯一单位就是<em>元</em>。这样我们就不必在任何单据或账中指明单位了。</p>
        <p>那么如果存在12瓶组合的箱包装呢？同样基于设计的便利，我们会建议建立另外一个物料<em>12瓶组合装X牌可乐</em>，其唯一的单位是箱。当然他们存在一定的转换关系，这个在后续的文章中会讨论。</p>
        <blockquote><p>问题：现实中人民币有元、角和分，我们需要建立3笔不同的记录吗？毛里塔尼亚的货币单位不是十进制，而是规定1乌吉亚等于5考姆斯，那么需要建立两笔记录吗？</p></blockquote>
        <h3>精度</h3>
        <p>在记录资源变动的数量时，我们还会限制精度，例如X牌可乐，我们无论如何都只允许整数，不会卖2.5瓶可乐。但是猪肉我们却可以卖3.25千克，他的精度是2位。在实践中，精度同样与特定的资源项关联，这样当销售X牌可乐时，自然就限定了只能是整数。</p>
        <p>有些软件，会设计精度与不同的活动也有关，例如在财务统计中，人民币可能会精确到小数4位，但在销售活动中，销售金额就只能到分，甚至大宗交易到元，但这不影响最终帐的帐的精度，他们使用需要小于或等于最小记账精度，但我个人认为把事情复杂化了。</p>
        <h3>主资料和规格</h3>
        <p>发生变动的资源既是主资料，例如：<em>X牌可乐</em>，<em>X牌可乐原浆</em>，<em>人民币</em>，这些都是主资料。他起到识别资源变动时键的作用。</p>
        <p>但很多复杂的需求中，主资料还需要加上规格来作为键，例如鞋是包含尺码的，X牌跑鞋 38码，这时才能在采购接收和出货时控制不同尺码的数量。下面罗列了常见的规格：</p>
        <ul>
            <li>尺码：常见在鞋、服装这些商品应用中；</li>
            <li>颜色：范围很广，例如服装，大家电，汽车都有颜色的区分；</li>
            <li>工艺：常见于五金材料，零配件等，某些商品完全通用，但他们制作的工艺和材质不同，造成售价不同；</li>
            <li>批次：在医药、食品行业使用最多，即使同一商品，同一工艺，可能只是生产的时间或锅炉不同，定义了不同的批次，用于追溯生产，如果某个批次的商品出现问题，同一批次的商品可能需要追回；</li>
        </ul>
        <p>在这些案例中，你也许注意到，商品可能没有任何规格，例如<em>人民币</em>，也可能只有一个，例如<em>X牌跑鞋 38码</em>，也可能包含多个规格，例如<em>X牌羊毛外套 L码 红色</em>；</p>
        <h3>变动方向</h3>
        <p>当我们采购一批商品入库时，这个仓库的商品资源是增加的，而当我们销售出库时，仓库的商品资源是减少。如果这个商品又被退回时，库存还是增加，这个商品如果已经损害，需要报废，资源再次减少。</p>
        <p>所以发生增加或减少，可以是很多种活动造成，依据职责单一原则，一般将变动方向与发生的活动分开处理，而变动方向使用正负号来表示，比如采购接收就是+3，出货是-3，销售退货，记+3，报废记-3。</p>
        <p>至于变动的种类（采购入库、销售出库、销售退回或报废等），属于辅助性信息，用于帮助创建各种报表，不在我们讨论的要素之列。</p>
        <p>财务系统中，使用借贷来描述变动方向，但他在不同的科目下其表示的增加和减少是不同的，所以我倾向于内部使用统一的概念处理。</p>
        <h3>日期</h3>
        <p>账还需要记录资源变动发生的时间点，这对于统计很有用，例如你可以统计： 某天12点整X牌可乐当时仓库有多少瓶，同样的你也可以统计当前还有多少瓶。还可以统计上个月x牌可乐采购接收、销售、退回或报废了多少。</p>
        <h3>实际发生和预期发生</h3>
        <p>在记录资源的变动时，除了已经发生的变动，我们还可以记录未来可能的变动。例如仓库现在有1000瓶X牌可乐，我已经向供应商预定了2000瓶，明天到货，那么当客户向我预定后天送3500瓶可乐时，我就知道还缺货500瓶而不是2500瓶。</p>
        <p>另外一个好处是，你可以获取一个清单，告诉你最近几天你需要督促供应商供应的清单，同时，也告诉自己准备哪些商品发送给客户。</p>
        <p>对于未来预期的减少，某些需求需要锁定机制，这超出了当前文章的范围，之后讨论。</p>
        <h3>位置</h3>
        <p>资源需要存放在某个位置，常见的概念就是仓库，一个企业可能多个仓库，这个时候我需要知道X牌可乐是放在哪个仓库。</p>
        <p>有些企业还需要精细到库位，知道商品到底放在哪个位置，一般采用库、架、层、位，但对于账来说就是一个Id，在变动时必须指明。</p>
        <p>对于组织内的资源移动，通常记出库组织资源的减少，入库组织资源的增加，如果还存在在途的管理，相当于移动的过程再增加<em>在途仓库</em>这个位置。</p>
        <p><em>位置</em>在软件设计上，还涉及安全的处理，某个位置的资源必然有保管人，例如A仓库的出库员不能将B仓库的商品报废了，或者两个不同的事业部，他们的出纳不能拿对方的钱。</p>
        <h3>来源</h3>
        <p>账的变化不能是平白无故的，必然是因为某个企业的活动造成的，所以在帐上要体现发生变动的活动来源，用来追溯来源。</p>
        <p>可能你会问，库存盘点时，发现真实库存与账面库存不符时，真的平白无故减少资源的，这种情况其实还是<em>盘亏</em>这个活动造成。</p>
        <h3>货主</h3>
        <p>在京东有第三方卖家，会将货物存放到京东的仓库，在销售后由京东代为发货，对于京东来说，他的系统在管理库存时，就需要区分仓库里面同样一种商品，可能是自己的，也可能是第三方卖家的，也就是说存货的这些商品是有货主的。<p>
            <h2>表结构的设计</h2>
        <p>在了解这些需求之后，我们开始设计表结构，注意，这里及其以后文章的设计都是基于当前的知识进度，不作为最终ERP设计的成果，在后面的章节中很可能还会变动，另外本表设计可能使用弹性域等高级设计。</p>
        <h3>库存流水账表</h3>
        <p>首先定义流水账表，也称为日志表，交易表，用于记录资源的所有变动，不同资源类型将定义不同的表，例如库存的定义库存流水账表，而财务的定义财务流水账表，会员积分的也定义一张新表。<p>
        <p>注意<em>帐</em>这类的表，其数据永远不会让用户直接录入，他们都是在业务单据（活动）生效时插入的，这有利于屏蔽业务单据复杂的业务设计，仅仅关注库存资源的变动。</p>
        <table>
            <tr>INV.MaterialTransactions 库存流水账表（范例） </tr>
            <tr>
                <th>字段名</th>
                <th>类型</th>
                <th>说明</th>
            </tr>
            <tr>
                <th>MaterialTransactionId</th>
                <th>int</th>
                <th>表的无意义主键。</th>
            </tr>
            <tr>
                <th>TransactionDate</th>
                <th>datetime</th>
                <th>交易发生的具体时间或预计未来发生的时间。</th>
            </tr>
            <tr>
                <th>IsVirtual</th>
                <th>bool</th>
                <th>false表示交易是真实发生的，true表示未来预期发生的，</th>
            </tr>
            <tr>
                <th>TransactionSource_TypeId</th>
                <th>int</th>
                <th>交易引证的来源类型编号，指向SYS.Elements。</th>
            </tr>
            <tr>
                <th>TransactionSource_Id</th>
                <th>int</th>
                <th>交易引证的来源编号，例如采购单的明细编号。</th>
            </tr>
            <tr>
                <th>TransactionObjectId</th>
                <th>int</th>
                <th>交易对象的弹性域对象编号，指向交易对象表，最终描述物料、尺码等信息。</th>
            </tr>
            <tr>
                <th>LocatorId</th>
                <th>int</th>
                <th>交易对象存放的位置编号，指向存放位置的弹性域。</th>
            </tr>
            <tr>
                <th>OwnerId</th>
                <th>int</th>
                <th>交易对象的所有者，指向所有者的弹性域。</th>
            </tr>
            <tr>
                <th>Qua</th>
                <th>decimal</th>
                <th>交易发生的数量，正数是增加，负数是减少。可以包含小数。</th>
            </tr>
        </table>
        <p>表的每行主要记录了：什么<em>时候</em>，什么<em>活动</em>造成什么<em>东西</em>从什么<em>地方</em>增加或减少了<em>多少</em>。</p>
        <h3>来源类型表</h3>
        <p>辅助性的表还包括：</p>
        <table>
            <tr>SYS.Elements 来源类型表（范例） </tr>
            <tr>
                <th>字段名</th>
                <th>类型</th>
                <th>说明</th>
            </tr>
            <tr>
                <th>ElementId</th>
                <th>int</th>
                <th>类型的无意义主键</th>
            </tr>
            <tr>
                <th>ElementName</th>
                <th>string</th>
                <th>元素唯一名称，也可以理解是表名称，例如来源是销售订单明细表，此值为：SalesOrderItems</th>
            </tr>
            <tr>
                <th>Caption</th>
                <th>string</th>
                <th>元素的本地化名称，例如来源是销售订单明细表，此值为：销售订单明细表</th>
            </tr>
        </table>
        <h3>交易对象表</h3>
        <table>
            <tr>INV.TransactionObject 交易对象（范例） </tr>
            <tr>
                <th>字段名</th>
                <th>类型</th>
                <th>说明</th>
            </tr>
            <tr>
                <th>TransactionObjectId</th>
                <th>int</th>
                <th>交易对象的无意义主键</th>
            </tr>
            <tr>
                <th>Code</th>
                <th>string</th>
                <th>交易对象的完整编码，他是弹性域组合后的代码。</th>
            </tr>
            <tr>
                <th>Caption</th>
                <th>string</th>
                <th>交易对象的完整显示名称，他是弹性域组合后的名称。</th>
            </tr>
            <tr>
                <th>UnitId</th>
                <th>int</th>
                <th>交易对象的定义组织编号</th>
            </tr>
            <tr>
                <th>ItemId</th>
                <th>int</th>
                <th>指向物料对象。</th>
            </tr>
            <tr>
                <th>SizeId</th>
                <th>int</th>
                <th>这里是一个示例，依据实施时的弹性域设置动态出现。</th>
            </tr>
        </table>
    </article>
</body>
</html>
